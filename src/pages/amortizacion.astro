---
import Layout from "../layouts/Layout.astro";
import Navbar from "../components/Navbar.astro";
import Footer from "../components/Footer.astro";
import { Settings, Zap, FileDown, CircleSlash, Sparkles } from "@lucide/astro";
---

<Layout
  title="Calculadora de Amortización | RIP Wallet"
  description="Gestiona tu deuda de forma inteligente. Calcula ahorros y visualiza el camino a tu libertad financiera."
>
  <Navbar currentPath="/calculadora" />

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-6 pt-16 pb-32">
    <header class="text-center mb-16 animate-reveal">
      <h1 class="text-5xl md:text-6xl font-bold tracking-tight mb-4">
        Calculadora de Amortización
      </h1>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      <!-- Barra Lateral -->
      <aside class="lg:col-span-4 space-y-6 animate-reveal">
        <!-- Configuración del Préstamo -->
        <div class="card-outline">
          <h4
            class="text-[10px] font-bold uppercase tracking-[0.2em] text-gray-400 mb-8 flex items-center"
          >
            <Settings class="w-3.5 h-3.5 mr-2" /> Configuración del Préstamo
          </h4>
          <div class="space-y-5">
            <div>
              <label
                class="block text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-2"
                >Moneda</label
              >
              <select id="currency" class="apple-input">
                <option value="USD">Dólares ($)</option>
                <option value="CRC">Colones (¢)</option>
                <option value="EUR">Euros (€)</option>
              </select>
            </div>
            <div>
              <label
                class="block text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-2"
                >Monto inicial</label
              >
              <input
                type="text"
                id="loanAmountFormatted"
                class="apple-input"
                value="100,000"
              />
              <input type="hidden" id="loanAmount" value="100000" />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label
                  class="block text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-2"
                  >Años</label
                >
                <input
                  type="number"
                  id="loanTerm"
                  class="apple-input"
                  value="20"
                />
              </div>
              <div>
                <label
                  class="block text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-2"
                  >Interés %</label
                >
                <input
                  type="number"
                  step="0.01"
                  id="interestRate"
                  class="apple-input"
                  value="8.5"
                />
              </div>
            </div>
          </div>
        </div>

        <!-- Cuota Mensual -->
        <div class="card-outline">
          <p
            class="text-[10px] font-bold uppercase tracking-[0.2em] text-gray-400 mb-4 text-center"
          >
            cuota mensual aproximada (sin seguros)
          </p>
          <h3
            class="text-3xl font-bold tracking-tight text-gray-900 text-center"
            id="monthlyPaymentDisplay"
          >
            $0.00
          </h3>
        </div>

        <!-- Abonos Extra -->
        <div class="card-outline">
          <h4
            class="text-[10px] font-bold uppercase tracking-[0.2em] text-green-600 mb-8 flex items-center"
          >
            <Zap class="w-3.5 h-3.5 mr-2 text-green-500" /> Abonos Extra
          </h4>
          <div class="space-y-5">
            <div>
              <label
                class="block text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-2"
                >Mensual adicional</label
              >
              <input
                type="text"
                id="extraMonthlyFormatted"
                class="apple-input"
                value="0"
              />
              <input type="hidden" id="extraMonthly" value="0" />
            </div>
            <div>
              <label
                class="block text-[10px] font-bold uppercase tracking-widest text-gray-400 mb-2"
                >Anual adicional (Dic)</label
              >
              <input
                type="text"
                id="extraAnnualFormatted"
                class="apple-input"
                value="0"
              />
              <input type="hidden" id="extraAnnual" value="0" />
            </div>
          </div>
        </div>

        <button id="downloadPdf" class="btn-report">
          <FileDown class="w-5 h-5" />
          <span>Descargar PDF</span>
        </button>
      </aside>

      <!-- Dashboard -->
      <section class="lg:col-span-8 space-y-6">
        <!-- Resultados Resumen -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 animate-reveal">
          <!-- Sin Amortización -->
          <div class="card-outline">
            <h4
              class="text-[10px] font-bold uppercase tracking-[0.2em] text-gray-400 mb-8 flex items-center"
            >
              <CircleSlash class="w-3.5 h-3.5 mr-2" /> Sin Amortizaciones
            </h4>
            <div class="space-y-5">
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600 font-medium"
                  >Intereses Totales</span
                >
                <span class="text-lg font-bold text-gray-900" id="stdInterest"
                  >$0.00</span
                >
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600 font-medium"
                  >Costo Final</span
                >
                <span class="text-lg font-bold text-gray-900" id="stdTotal"
                  >$0.00</span
                >
              </div>
            </div>
          </div>

          <!-- Impacto de Abonos -->
          <div class="card-outline">
            <h4
              class="text-[10px] font-bold uppercase tracking-[0.2em] text-green-600 mb-8 flex items-center"
            >
              <Sparkles class="w-3.5 h-3.5 mr-2 text-green-600" /> Impacto de tus
              abonos
            </h4>
            <div class="space-y-5">
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600 font-medium"
                  >Ahorro en Intereses</span
                >
                <span
                  class="text-lg font-bold text-green-600"
                  id="savingsAmount">$0.00</span
                >
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600 font-medium"
                  >Reducción de Tiempo</span
                >
                <span class="text-lg font-bold text-green-600" id="timeSaved"
                  >0 meses</span
                >
              </div>
            </div>
          </div>
        </div>

        <!-- Gráfico de Líneas -->
        <div class="card-outline">
          <div
            class="flex flex-col md:flex-row items-start md:items-center justify-between mb-8 gap-6 md:gap-0"
          >
            <h4
              class="font-bold text-xl md:text-2xl text-gray-900 leading-tight"
            >
              Progreso de la Deuda
            </h4>

            <div
              class="w-full md:w-auto grid grid-cols-2 gap-4 md:flex md:items-center md:space-x-8"
            >
              <!-- Estándar -->
              <div
                class="flex items-center justify-center md:justify-start bg-gray-50 md:bg-transparent rounded-lg py-3 px-4 md:p-0 border border-gray-100 md:border-0"
              >
                <span class="w-2.5 h-2.5 rounded-full bg-gray-200 mr-2.5"
                ></span>
                <span
                  class="text-[11px] font-bold uppercase tracking-widest text-gray-400"
                  >Estándar</span
                >
              </div>

              <!-- Con Abonos -->
              <div
                class="flex items-center justify-center md:justify-start bg-green-50/50 md:bg-transparent rounded-lg py-3 px-4 md:p-0 border border-green-100 md:border-0"
              >
                <span class="w-2.5 h-2.5 rounded-full bg-green-600 mr-2.5"
                ></span>
                <span
                  class="text-[11px] font-bold uppercase tracking-widest text-green-700"
                  >Con Abonos</span
                >
              </div>
            </div>
          </div>
          <div class="h-87.5">
            <canvas id="lineChart"></canvas>
          </div>
        </div>

        <!-- Tabla -->
        <div class="card-outline p-0! overflow-hidden animate-reveal">
          <div class="p-8 border-b border-gray-100">
            <h4 class="font-bold text-lg text-gray-900">Plan de Pagos Anual</h4>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
              <thead>
                <tr class="bg-gray-50/50">
                  <th
                    class="px-8 py-5 text-[9px] font-bold uppercase tracking-widest text-gray-400 border-b border-gray-100"
                    >Año</th
                  >
                  <th
                    class="px-8 py-5 text-[9px] font-bold uppercase tracking-widest text-gray-400 border-b border-gray-100"
                    >Interés</th
                  >
                  <th
                    class="px-8 py-4 text-[9px] font-bold uppercase tracking-widest text-gray-400 border-b border-gray-100"
                    >Capital</th
                  >
                  <th
                    class="px-8 py-5 text-[9px] font-bold uppercase tracking-widest text-gray-400 border-b border-gray-100"
                    >Saldo Final</th
                  >
                </tr>
              </thead>
              <tbody id="amortizationTableBody" class="text-sm font-medium"
              ></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </main>

  <Footer />
</Layout>

<script>
  import Chart from "chart.js/auto";
  import { jsPDF } from "jspdf";
  import autoTable from "jspdf-autotable";

  function setupCalculator() {
    const numericInputs = [
      { display: "loanAmountFormatted", hidden: "loanAmount" },
      { display: "extraMonthlyFormatted", hidden: "extraMonthly" },
      { display: "extraAnnualFormatted", hidden: "extraAnnual" },
    ];

    const otherInputs = ["loanTerm", "interestRate", "currency"];
    const elements: any = {};

    numericInputs.forEach((item) => {
      const displayEl = document.getElementById(
        item.display
      ) as HTMLInputElement;
      const hiddenEl = document.getElementById(item.hidden) as HTMLInputElement;
      if (!displayEl || !hiddenEl) return;

      elements[item.hidden] = hiddenEl;

      displayEl.addEventListener("input", (e: Event) => {
        const target = e.target as HTMLInputElement;
        let val = target.value.replace(/,/g, "");
        if (isNaN(Number(val))) val = "0";

        hiddenEl.value = val;
        if (val !== "") {
          target.value = Number(val).toLocaleString("en-US");
        }
        calculate();
      });
    });

    otherInputs.forEach((id) => {
      const el = document.getElementById(id);
      if (el) {
        elements[id] = el;
        el.addEventListener("input", calculate);
      }
    });

    let lineChart: Chart | null = null;
    let yearlyDetails: any[] = [];

    function formatVal(val: number) {
      const curr = elements.currency.value;
      if (curr === "CRC") {
        return (
          "¢" +
          new Intl.NumberFormat("en-US", {
            maximumFractionDigits: 0,
          }).format(val)
        );
      }
      if (curr === "USD") {
        return (
          "$" +
          new Intl.NumberFormat("en-US", {
            maximumFractionDigits: 0,
          }).format(val)
        );
      }
      return new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: curr,
        maximumFractionDigits: 0,
      }).format(val);
    }

    function initChart() {
      const canvas = document.getElementById("lineChart") as HTMLCanvasElement;
      if (!canvas) return;

      const ctx = canvas.getContext("2d");
      if (!ctx) return;

      lineChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Original",
              data: [],
              borderColor: "#e2e8f0",
              borderWidth: 2,
              pointRadius: 0,
              fill: false,
              tension: 0.3,
              borderDash: [5, 5],
            },
            {
              label: "Acelerado",
              data: [],
              borderColor: "#17A34A",
              borderWidth: 3,
              pointRadius: 0,
              fill: true,
              backgroundColor: "rgba(124, 228, 149, 0.03)",
              tension: 0.3,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              ticks: { font: { family: "Poppins", size: 9 }, color: "#9ca3af" },
              grid: { color: "#f1f5f9" },
            },
            x: {
              ticks: { font: { family: "Poppins", size: 9 }, color: "#9ca3af" },
              grid: { display: false },
            },
          },
        },
      });
    }

    function simulate(
      p: number,
      r: number,
      t: number,
      extraM: number,
      extraA: number
    ) {
      const monthlyRate = r / 100 / 12;
      const totalMonths = t * 12;
      const basePayment =
        (p * monthlyRate * Math.pow(1 + monthlyRate, totalMonths)) /
        (Math.pow(1 + monthlyRate, totalMonths) - 1);

      let balance = p;
      let totalInt = 0;
      let month = 0;
      let yData: any[] = [];
      let balances = [p];
      let yInt = 0,
        yCap = 0;

      while (balance > 0.01 && month < 600) {
        month++;
        let interest = balance * monthlyRate;
        let capFromPay = basePayment - interest;
        let extra = extraM + (month % 12 === 0 ? extraA : 0);
        let totalCap = Math.min(balance, capFromPay + extra);

        totalInt += interest;
        balance -= totalCap;
        yInt += interest;
        yCap += totalCap;
        balances.push(balance);

        if (month % 12 === 0 || balance <= 0) {
          yData.push({
            year: Math.ceil(month / 12),
            interest: yInt,
            capital: yCap,
            balance: Math.max(0, balance),
          });
          yInt = 0;
          yCap = 0;
        }
        if (balance <= 0) break;
      }
      return {
        totalInt,
        totalCost: p + totalInt,
        basePayment,
        months: month,
        yData,
        balances,
      };
    }

    function calculate() {
      const p = parseFloat(elements.loanAmount?.value) || 0;
      const t = parseFloat(elements.loanTerm?.value) || 0;
      const r = parseFloat(elements.interestRate?.value) || 0;
      const eM = parseFloat(elements.extraMonthly?.value) || 0;
      const eA = parseFloat(elements.extraAnnual?.value) || 0;

      if (p <= 0 || t <= 0) return;

      const std = simulate(p, r, t, 0, 0);
      const adv = simulate(p, r, t, eM, eA);
      yearlyDetails = adv.yData;

      const monthlyEl = document.getElementById("monthlyPaymentDisplay");
      const stdInterestEl = document.getElementById("stdInterest");
      const stdTotalEl = document.getElementById("stdTotal");
      const savingsEl = document.getElementById("savingsAmount");
      const timeSavedEl = document.getElementById("timeSaved");
      const tableBodyEl = document.getElementById("amortizationTableBody");

      if (monthlyEl) monthlyEl.textContent = formatVal(std.basePayment);
      if (stdInterestEl) stdInterestEl.textContent = formatVal(std.totalInt);
      if (stdTotalEl) stdTotalEl.textContent = formatVal(std.totalCost);
      if (savingsEl)
        savingsEl.textContent = formatVal(std.totalInt - adv.totalInt);

      const diff = std.months - adv.months;
      if (timeSavedEl)
        timeSavedEl.textContent = `${Math.floor(diff / 12)} años, ${
          diff % 12
        } m`;

      if (lineChart) {
        lineChart.data.labels = Array.from(
          { length: Math.max(std.balances.length, adv.balances.length) },
          (_, i) => Math.ceil(i / 12)
        );
        lineChart.data.datasets[0].data = std.balances;
        lineChart.data.datasets[1].data = adv.balances;
        lineChart.update();
      }

      if (tableBodyEl) {
        tableBodyEl.innerHTML = adv.yData
          .map(
            (y) => `
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-8 py-5 font-bold text-gray-900">${y.year}</td>
            <td class="px-8 py-5 text-gray-500">${formatVal(y.interest)}</td>
            <td class="px-8 py-5 text-gray-500">${formatVal(y.capital)}</td>
            <td class="px-8 py-5 font-bold text-gray-900">${formatVal(
              y.balance
            )}</td>
          </tr>
        `
          )
          .join("");
      }
    }

    async function generatePDF() {
      const doc = new jsPDF("p", "mm", "a4");
      const currency = elements.currency.value;

      doc.setFont("helvetica", "bold");
      doc.setFontSize(22);
      doc.text("Plan de pago anticipado", 20, 30);

      doc.setFontSize(10);
      doc.setFont("helvetica", "normal");
      doc.text(
        `RIP Wallet | www.ripwallet.co - ${new Date().toLocaleDateString()}`,
        20,
        38
      );

      doc.setFontSize(12);
      doc.setFont("helvetica", "bold");
      doc.text("Configuración del Préstamo", 20, 55);

      const inputData = [
        [
          "Moneda",
          currency === "USD" ? "$" : currency === "CRC" ? "¢" : currency,
        ],
        ["Monto Inicial", formatVal(parseFloat(elements.loanAmount.value))],
        ["Plazo Original", `${elements.loanTerm.value} años`],
        ["Tasa de Interés", `${elements.interestRate.value}%`],
        [
          "Abono Mensual Extra",
          formatVal(parseFloat(elements.extraMonthly.value)),
        ],
        [
          "Abono Anual Extra (Dic)",
          formatVal(parseFloat(elements.extraAnnual.value)),
        ],
      ];

      autoTable(doc, {
        startY: 60,
        body: inputData,
        theme: "plain",
        styles: { fontSize: 9, cellPadding: 2 },
      });

      const canvas = document.getElementById("lineChart") as HTMLCanvasElement;
      if (canvas) {
        const chartImg = canvas.toDataURL("image/png", 1.0);
        doc.addPage();
        doc.setFontSize(14);
        doc.text("Gráfico de Progreso de la Deuda", 20, 30);
        doc.addImage(chartImg, "PNG", 20, 40, 170, 100);
      }

      doc.save(`RIP-Wallet-Plan-Amortizacion-${new Date().getTime()}.pdf`);
    }

    const downloadBtn = document.getElementById("downloadPdf");
    if (downloadBtn) {
      downloadBtn.addEventListener("click", generatePDF);
    }

    initChart();
    calculate();
  }

  setupCalculator();
  document.addEventListener("astro:page-load", setupCalculator);
</script>

<style is:global>
  .apple-input {
    width: 100%;
    background-color: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s;
  }

  .apple-input:focus {
    outline: none;
    background-color: #ffffff;
    border-color: #60a5fa;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.05);
  }

  .card-outline {
    background-color: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 24px;
    padding: 32px;
    transition: border-color 0.3s ease;
  }

  .card-outline:hover {
    border-color: #cbd5e1;
  }

  .btn-report {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    width: 100%;
    background-color: #17a34a;
    color: #ffffff;
    padding: 16px 32px;
    border-radius: 9999px;
    font-weight: 600;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 6px -1px rgba(0, 122, 255, 0.1);
    border: none;
    cursor: pointer;
  }

  .btn-report:hover {
    background-color: #1cc95b;
    box-shadow: 0 20px 25px -5px rgba(124, 228, 149, 0.3);
  }

  .btn-report:active {
    transform: scale(0.96);
  }

  @keyframes reveal {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-reveal {
    opacity: 0;
    animation: reveal 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }
</style>
